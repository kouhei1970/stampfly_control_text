# StampFlyハードウェア完全解説 - StampFly制御システム第2回

## この記事で学ぶこと（2分で読める概要）

第1回で学んだ物理的連鎖（PWM→ESC→モータ→プロペラ→推力）を実現する、M5StampFlyの具体的なハードウェア構成を完全解説します：

1. **StampFlyの全体像**：36.8gに凝縮された高性能システム
2. **9つのセンサの役割**：なぜこのセンサが必要なのか
3. **ESP32-S3の能力**：240MHzデュアルコアが400Hz制御を可能にする理由
4. **通信機能の価値**：ESP-NOWがもたらすドローン制御の革新

**重要な発見**：StampFlyは単なる小型ドローンではなく、ドローン制御技術を学ぶために最適化された「空飛ぶ学習プラットフォーム」です。

## M5StampFlyとは何か（基本理解）

### StampFlyの正体

M5StampFlyは、**教育・学習に特化した超小型ドローン**です。一般的なドローンとは根本的に設計思想が異なります。

### 基本スペック一覧

| 項目 | 仕様 | 他機種との違い |
|------|------|--------------|
| **重量** | 36.8g | 超軽量（法規制100g未満） |
| **SoC** | ESP32-S3 | WiFi/Bluetooth標準搭載 |
| **制御周期** | 400Hz | 高速リアルタイム制御 |
| **センサ数** | 9個 | 高密度センサ統合 |
| **通信** | ESP-NOW | プロポ不要の革新性 |
| **サイズ** | 81.5×81.5×31mm | 手のひらサイズ |
| **バッテリー** | 300mAh HV LiPo | 約4分飛行 |

### なぜStampFlyが特別なのか

**1. 学習プラットフォームとして最適化**
- オープンソース設計で改造・拡張が自由
- Arduino/ESP-IDF両対応で学習レベルに応じて選択可能
- 詳細な技術資料とサンプルコードを完備

**2. プロポ不要の簡単セットアップ**
- ESP-NOW通信で送信機を別途購入する必要なし
- スマートフォンやPCから直接制御可能
- ペアリング設定も数分で完了

**3. 超軽量で安全性が高い**
- 100g未満で航空法の規制が大幅緩和
- 室内飛行に最適な重量とサイズ
- 衝突時の安全性を重視した設計

**4. 高性能な制御システム**
- 400Hz制御で産業用ドローンと同等の応答性
- 9種類のセンサによる高精度な状態推定
- リアルタイムOS（FreeRTOS）による安定動作

## 9つのセンサが創る飛行システム

StampFlyに搭載された9つのセンサは、それぞれが重要な役割を担っています。

### 姿勢制御の心臓部

**BMI270（6軸IMU - SPI接続）**

```
役割：機体の傾きと回転速度を検出
接続：SPI（10MHz高速通信）
データ：角速度3軸 + 加速度3軸
更新頻度：400Hz（2.5ms毎）
```

**なぜSPI接続なのか？**
- I2C（400kHz）：1秒間に約400,000回通信可能
- SPI（10MHz）：1秒間に約10,000,000回通信可能

400Hz制御では2.5ms毎にIMUデータが必要なため、SPIの高速性が不可欠です。

### 環境認識センサ群

**BMM150（磁力計 - I2C接続）**
- **役割**：方位（北の方角）を検出
- **重要性**：GPS無しでも機首方向を維持
- **精度**：0.3μT（地磁気の微細な変化を検出）

**BMP280（気圧センサ - I2C接続）**
- **役割**：気圧変化による高度推定
- **精度**：数cm単位の高度変化を検出
- **応答性**：高度維持制御の基盤

**VL53L3CX×2（距離センサ - I2C接続）**
- **役割**：ToF（Time of Flight）方式で距離測定
- **配置**：前方・下方の2個で全方位カバー
- **測定範囲**：5cm〜4m
- **用途**：障害物回避、自動着陸

**PMW3901MB（オプティカルフロー - SPI接続）**
- **役割**：地面との相対移動を光学的に検出
- **原理**：マウスセンサーと同じ技術
- **精度**：数mm単位の水平移動を検出
- **GPS代替**：屋内でのポジション保持

### システム監視センサ

**INA3221（電圧・電流モニタ - I2C接続）**
- **役割**：バッテリー状態の監視
- **測定項目**：電圧、電流、電力消費
- **安全機能**：低電圧時の自動着陸トリガー

## ESP32-S3の制御能力解説

### なぜ240MHzで400Hz制御が可能なのか

**デュアルコアの威力**

```
Core 0（通信専用）:
├─ WiFi関連タスク（ESP-IDFが自動配置）
├─ ESP-NOW通信処理
├─ システムモニタリング
└─ テレメトリ送信

Core 1（制御専用）:
├─ センサデータ読み取り（400Hz）
├─ 姿勢制御演算（PID制御）
├─ モータミキシング計算
└─ PWM信号出力
```

**計算能力の内訳**
- **400Hz制御** = 2.5ms周期で制御ループ実行
- **240MHz CPU** = 1秒間に2億4000万回計算
- **2.5ms間に60万回計算可能** = センサ読み取り〜PWM出力まで余裕で実行

### 他のマイコンとの比較

| マイコン | 周波数 | 制御周期 | デュアルコア | 通信機能 |
|----------|--------|----------|-------------|----------|
| Arduino Uno | 16MHz | 50Hz程度 | × | なし |
| ESP32 | 240MHz | 200Hz程度 | ○ | WiFi/BT |
| **ESP32-S3** | **240MHz** | **400Hz** | **○** | **WiFi/BT + 省電力** |

ESP32-S3は、ドローン制御に必要な全ての要素を1チップに統合した理想的なSoCです。

## 通信機能がもたらす革新

### ESP-NOWの価値（プロポが不要になる理由）

**従来のドローンシステム**
```
ドローン本体 + プロポ送信機 + 受信機 = 複雑で高コスト
```

**StampFlyの革新**
```
ESP32-S3内蔵通信 = 本体のみで完結
```

### ESP-NOWの特徴

**技術的優位性**
- **低遅延**：数msの応答速度
- **低消費電力**：バッテリー寿命向上
- **高信頼性**：2.4GHz帯の安定通信
- **ペア接続**：最大20台のペア接続、ブロードキャスト通信で数百台対応（群制御対応）

**学習・開発での価値**
- **独自コントローラー**を簡単に作成可能
- **スマートフォンアプリ**からの直接制御
- **デバッグ情報**のリアルタイム送信
- **群制御実験**も可能

この通信機能により、StampFlyは学習用プラットフォームとして最適な選択となっています。プロポを別途購入することなく、すぐにドローン制御の実験を開始できます。

## 物理設計の工夫

### 36.8gに込められた設計思想

**軽量化の理由**

**1. 法規制対応**
- 100g未満で航空法の規制が大幅緩和
- 屋内飛行に最適な重量範囲
- 許可申請不要で教育利用可能

**2. 安全性向上**
- 軽いほど衝突時のリスクが低減
- 人への危害を最小限に抑制
- 教育現場での安全性確保

**3. 機敏性向上**
- 慣性が小さく高速な姿勢変更が可能
- 応答性の良い制御特性
- アクロバティックな飛行も実現

### コンパクト設計の効果

**配線の最適化**
- 短い配線によるノイズ軽減
- 電磁干渉の最小化
- 信号品質の向上

**振動の抑制**
- コンパクトな構造による振動減衰
- センサ精度の向上
- 制御安定性の向上

**組み立て簡素化**
- 学習用として最適な複雑さ
- メンテナンス性の向上
- 拡張・改造の容易さ

## デュアルコアの活用戦略

### Core分離による高性能制御

ESP32-S3の2つのコアを効果的に使い分けることが、400Hz高速制御の鍵です。

**Core 0（WiFi/ESP-NOW + 軽量処理）**
- WiFi関連タスク（ESP-IDFがデフォルトで配置）
- ESP-NOW通信処理
- システムモニタリング
- テレメトリ送信

**Core 1（制御演算専用）**
- 400Hzでカスケード制御実行
- 高速センサ読み取り（IMU等）
- モータミキシング計算
- PWM信号出力

**重要な制約**：ESP-IDFではWiFi機能（ESP-NOWを含む）が強制的にCore 0で実行されます。このため：

- **Core 0**: ESP-NOW通信処理（ESP-IDFの制約）
- **Core 1**: 400Hz制御演算（リアルタイム保証）

この制約により、リアルタイム制御はCore 1に集約する設計が必須となります。

## StampFlyでできること（可能性の紹介）

### 学習用途

**ドローン制御の基礎学習**
- 物理的連鎖の理解（PWM→推力）
- PID制御の実装と調整
- センサ融合の基本概念

**プログラミング実習**
- C/C++でのリアルタイム制御
- FreeRTOSを使ったマルチタスク
- 通信プロトコルの実装

**センサ融合の理解**
- IMU、磁力計、気圧計の統合
- カルマンフィルタの実装
- 状態推定アルゴリズム

### 研究用途

**制御アルゴリズムの検証**
- 新しいPID調整手法
- 適応制御の実装
- ロバスト制御の評価

**群制御実験**
- 複数機による連携飛行
- 編隊飛行アルゴリズム
- 分散制御システム

**AI制御の実装**
- 機械学習による制御最適化
- 強化学習エージェント
- ニューラルネットワーク制御

### 拡張可能性

**ハードウェア拡張**
- カメラ追加でFPV飛行
- GPS追加で屋外自律飛行
- 独自センサ追加で特殊用途

**ソフトウェア拡張**
- 独自の制御アルゴリズム
- カスタム通信プロトコル
- リアルタイム画像処理

## センサ統合の重要性

### センサ融合による状態推定

ドローンの安定飛行には、複数のセンサデータを統合した正確な状態推定が必要です：

**I2Cバス接続センサ（400kHz）**
- **磁気センサ（BMM150）**：3軸地磁気検出（方位推定用）
- **気圧計（BMP280）**：気圧による高度推定
- **距離センサ（VL53L3CX×2）**：ToF方式による対地距離測定
- **電圧・電流モニタ（INA3221）**：バッテリー状態監視

**SPIバス接続センサ（最大10MHz）**
- **IMU（BMI270）**：6軸慣性センサ（角速度と加速度）
- **オプティカルフロー（PMW3901MB）**：光学式の水平移動検出

これらのセンサは異なるインターフェースで接続され、それぞれの特性に最適化された通信速度で動作します。I2Cは配線が簡単で複数デバイスを接続でき、SPIは高速データ転送が必要なIMUとオプティカルフローに使用されています。

### なぜBMI270はSPI接続なのか？

**理由**：IMUは最も高頻度でデータを読み取る必要があるためです。

- **I2C（400kHz）**：1秒間に約400,000回通信可能
- **SPI（10MHz）**：1秒間に約10,000,000回通信可能

**400Hzの制御周期**では、IMUを2.5ms毎に読む必要があり、SPIの高速性が必要不可欠です。

## まとめ：学習プラットフォームとしてのStampFly

M5StampFlyは、単なる小型ドローンではありません。ドローン制御技術を学ぶために最適化された「空飛ぶ学習プラットフォーム」です。

### StampFlyの価値

**1. 包括的な学習環境**
- 9つのセンサによる実践的なセンサ融合学習
- 400Hz制御による本格的なリアルタイム制御体験
- ESP-NOWによる通信システムの理解

**2. 段階的な学習サポート**
- Arduino IDEでの入門から
- ESP-IDFでの本格的な組み込み開発まで
- 個人の学習レベルに応じた柔軟な対応

**3. 実践的な応用可能性**
- 研究レベルの制御アルゴリズム検証
- 群制御やAI制御の実装基盤
- 産業応用への発展

**4. 安全で始めやすい環境**
- 36.8gの超軽量設計による安全性
- プロポ不要の簡単セットアップ
- 室内飛行に最適な仕様

次回の第3回では、StampFlyの心臓部である「モータ・ESC・プロペラシステム」について、推力がどのように生成され、制御されるのかを詳しく解説します。

## StampFly技術仕様（リファレンス）

### ピンアサイン一覧

#### I2C接続センサ（400kHz共通バス）

| デバイス | SDA | SCL | I2Cアドレス |
|----------|-----|-----|-------------|
| BMP280（気圧センサ） | G3 | G4 | 0x76 |
| BMM150（磁力計） | G3 | G4 | 0x10 |
| VL53L3CX（距離センサ×2） | G3 | G4 | 0x52, 0x54 |
| INA3221（電流監視） | G3 | G4 | 0x40 |

#### SPI接続センサ（高速通信）

| デバイス | MOSI | MISO | SCK | CS | 速度 |
|----------|------|------|-----|----|----|
| BMI270（IMU） | G14 | G43 | G44 | G46 | 10MHz |
| PMW3901MB（オプティカルフロー） | G14 | G43 | G44 | G12 | 10MHz |

#### モータPWM出力

| モータ位置 | ピン | 回転方向 | 備考 |
|------------|------|----------|------|
| M1（右前） | G6 | 反時計回り（CCW） | 左回り |
| M2（左前） | G5 | 時計回り（CW） | 右回り |
| M3（左後） | G8 | 反時計回り（CCW） | 左回り |
| M4（右後） | G7 | 時計回り（CW） | 右回り |

#### Grove端子

| コネクタ | 機能 | SDA/TX | SCL/RX |
|----------|------|--------|--------|
| 赤（A） | I2C | G13 | G15 |
| 黒（B） | UART | G1 | G2 |

#### その他出力

| デバイス | ピン | 用途 |
|----------|------|------|
| ブザー | G12 | 状態通知 |
| WS2812 RGB LED | G39 | 外部LED |
| 内蔵RGB LED | G21 | M5StampS3内蔵 |

### モータ回転方向図（上から見た図）

```
        前方
         ↑
    [M2]    [M1]
     CW      CCW
      \      /
       \____/
       /    \
    [M3]    [M4]
     CCW      CW
         ↓
       後方
```

**重要**：対角モータが同じ回転方向になるよう配置され、トルクバランスを実現しています。

---

**シリーズ**: 基礎・ハードウェア編  
**対象読者**: 全レベル  
**推定読了時間**: 8分  
**前提知識**: 第1回の物理的連鎖の理解  
**次回予告**: 第3回「モータ・ESC・プロペラの物理学」

**コード例について**: 本記事のコード例は学習目的で簡略化されています。実際の使用時は、エラーハンドリング、安全機能、最適化を追加してください。

**参考資料**:
- [StampFlyで学ぶマルチコプタ制御](https://www.docswell.com/s/Kouhei_Ito/K38V1P-2024-02-10-094123)
- [「マルチコプタの運動と制御」基礎のきそ](https://www.docswell.com/s/Kouhei_Ito/KDVNVK-2022-06-15-193343)

---

## 免責事項

本記事の内容は教育・学習目的で提供されています。ドローンの製作・飛行に関しては以下の点にご注意ください：

- **法規制の遵守**：航空法、電波法等の関連法規を必ず確認し、遵守してください
- **安全性の確保**：機体の整備、飛行環境の安全確認は製作者・操縦者の責任です
- **技術的内容**：記事中のコードや設計は例示であり、実際の使用時は十分な検証が必要です
- **損害の免責**：本記事の内容に起因する損害について、著者は責任を負いかねます

安全第一でドローン技術を学び、楽しんでください。