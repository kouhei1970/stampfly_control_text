# StampFly制御システム完全ガイド - プロジェクト要件定義

## プロジェクト概要

**プロジェクト名**: StampFly制御システム完全ガイド  
**目的**: M5StampFlyを使ったマルチコプタ制御システムの教育・技術解説  
**作成日**: 2025-07-02  
**最終更新**: 2025-07-04  

## プロジェクトの目的

### 主目的
M5StampFlyプラットフォームを用いたマルチコプタ制御システムの実装方法を詳細に解説し、ドローン制御技術の学習・教育に貢献する。

### 具体的な目標
1. **教育的価値の提供**: 制御理論から実装まで体系的に学習できる教材の作成
2. **実装技術の解説**: ESP32-S3による実際の組み込み制御システムの詳細解説
3. **安全性重視**: 安全を最優先とした設計思想の普及
4. **オープンソース貢献**: 技術コミュニティへの知識共有

## 対象読者

### プライマリ対象
- ドローン制御を学ぶエンジニア
- 組み込みシステム開発者
- 制御理論の実装に興味がある学生・研究者

### セカンダリ対象
- 自作ドローンに興味があるメイカー
- ロボティクス分野の初学者
- ESP32-S3を使った開発に興味がある開発者

## 技術要件

### ハードウェア仕様
- **メインボード**: M5StampS3 (ESP32-S3)
- **IMU**: BMI270 (加速度計・ジャイロスコープ)
- **磁力計**: BMM150
- **気圧センサ**: BMP280
- **距離センサ**: VL53L3CX (×2)
- **オプティカルフロー**: PMW3901MB
- **モータ**: 716-17600kv ブラシレスモータ (×4)
- **バッテリー**: 300mAh 1S高電圧リチウムポリマー

### ソフトウェア仕様
- **開発環境**: ESP-IDF (ESP32 IoT Development Framework)
- **RTOS**: FreeRTOS
- **通信**: ESP-NOW (低遅延無線通信)
- **プログラミング言語**: C/C++

## 機能要件

### 基本制御機能
1. **センサフュージョン**
   - IMUデータの処理とフィルタリング
   - 相補フィルタ・Madgwickフィルタの実装
   - 拡張カルマンフィルタによる状態推定

2. **階層的制御システム**
   - 角速度制御 (最内側ループ)
   - 姿勢制御 (中間ループ)
   - 速度制御
   - 位置制御 (最外側ループ)

3. **フライトモード**
   - マニュアル (アクロバティック)
   - スタビライズ (自己水平)
   - 高度維持
   - 位置保持
   - 自動飛行

### 安全機能
1. **フェイルセーフ機能**
   - バッテリー電圧監視
   - 姿勢角度制限
   - 高度制限
   - ジオフェンス

2. **緊急時対応**
   - 緊急着陸
   - Return to Launch (RTL)
   - 通信途絶時の自動対応

### 通信機能
1. **ESP-NOW通信**
   - 低遅延制御コマンド受信
   - リアルタイムテレメトリ送信
   - 通信品質監視

2. **コマンドプロトコル**
   - アーム/ディスアーム
   - フライトモード切替
   - 自動離着陸
   - ウェイポイントナビゲーション

## 非機能要件

### 性能要件
- **制御周期**: 500Hz (角速度制御)
- **通信遅延**: 10ms以下 (ESP-NOW)
- **センサ更新頻度**: 1kHz (IMU)
- **飛行時間**: 約5-7分 (300mAhバッテリー)

### 信頼性要件
- **可用性**: 99%以上の制御ループ実行
- **安全性**: FMEA (故障モード影響解析) に基づく設計
- **堅牢性**: 外乱に対する安定性

### 保守性要件
- **モジュール化**: 機能別に分離された設計
- **テスタビリティ**: 単体テスト可能な構造
- **ドキュメント**: 詳細な技術解説とコメント

## 教育的要件

### 学習目標
1. **制御理論の理解**
   - PID制御の原理と調整方法
   - カスケード制御の設計
   - フィードフォワード制御の活用

2. **センサフュージョン技術**
   - 各種フィルタアルゴリズムの実装
   - ノイズ除去とデータ融合
   - 状態推定の理論と実践

3. **組み込みシステム開発**
   - FreeRTOSによるリアルタイム制御
   - ESP-IDFを使った開発手法
   - ハードウェア抽象化層の設計

### 解説内容
- **段階的学習**: 基礎から応用まで段階的に解説
- **実装例**: 実際に動作するコード例の提供
- **理論と実践**: 理論的背景と実装の両方を解説
- **トラブルシューティング**: よくある問題と解決方法

## 品質要件

### コード品質
- **可読性**: わかりやすいコメントと命名規則
- **保守性**: モジュール化された構造
- **再利用性**: 他のプロジェクトでも活用可能
- **安全性**: メモリ安全性とリソース管理

### ドキュメント品質
- **完全性**: 実装に必要な全ての情報を含む
- **正確性**: 技術的に正確で検証済みの内容
- **最新性**: 使用技術の最新バージョンに対応

### 2025-07-04 追加要件

#### コード説明の明確化
- **コード掲載前の説明必須**: 全てのコードブロック前に目的・理由・読み方を明記
- **理論と実装の橋渡し**: 抽象的説明の曖昧さを具体的コードで排除
- **初心者配慮**: ハードウェア抽象化等の概念を段階的・丁寧に解説

#### 技術的正確性の強化
- **実機仕様準拠**: M5StampFly実機の正確なピンアサイン・ハードウェア構成に基づく
- **接続方式の正確性**: センサ接続（I2C/SPI）の技術的根拠を明確化
- **通信機能の重視**: ESP32-S3標準通信機能（WiFi/Bluetooth/ESP-NOW）の価値を強調

#### 安全性・法的配慮
- **免責事項の標準化**: 全記事に法規制遵守・安全確保・技術的検証の注意喚起
- **教育目的の明確化**: 学習・教育目的であることの明示
- **責任範囲の明確化**: 著者の責任範囲と読者の責任範囲の明確な区分

#### はてなブログ対応
- **書式仕様準拠**: はてなブログの箇条書きルール等への完全準拠
- **読みやすさ向上**: markdown形式での適切な書式設定

#### Git運用ルール
- **コミットメッセージ**: Claude/AI関連の文言を含めない（GitHubのcontributor履歴対策）
- **著者情報**: 人間の開発者のみをcontributorとして記録
- **アクセシビリティ**: 初心者にも理解しやすい説明

## プロジェクト制約

### 技術的制約
- ESP32-S3の処理能力とメモリ制限
- 300mAhバッテリーによる飛行時間制限
- ESP-NOWの通信距離制限
- センサ精度の物理的限界

### 安全性制約
- 教育目的に限定した使用
- 安全な環境での飛行テストのみ
- 適切な保護装置の使用
- 法規制の遵守

### リソース制約
- オープンソースライブラリの活用
- 商用利用可能なコンポーネントの使用
- 入手しやすい部品での構成

## 成功基準

### 技術的成功基準
1. **動作実証**: 実機での安定飛行の実現
2. **制御性能**: 設計仕様を満たす制御性能
3. **安全性**: 安全機能の正常動作
4. **再現性**: 他者による実装の成功

### 教育的成功基準
1. **理解度**: 制御理論の理解促進
2. **実装力**: 実際のシステム構築能力の向上
3. **応用力**: 他のロボティクスシステムへの応用
4. **コミュニティ貢献**: 技術コミュニティでの活用

## リスク管理

### 技術的リスク
- **ハードウェア故障**: 冗長化と保護回路
- **ソフトウェア不具合**: 段階的テストと検証
- **通信障害**: フェイルセーフ機能の実装
- **制御不安定**: シミュレーションによる事前検証

### 安全性リスク
- **安全飛行**: 適切な環境での飛行制限
- **バッテリー過放電**: 電圧監視と自動着陸
- **制御失効**: 緊急停止機能
- **法規制違反**: 適切な飛行環境の選択

## 関連技術・参考資料

### 技術標準
- ESP-IDF Programming Guide
- FreeRTOS Kernel Developer's Guide
- IEEE Standards for Control Systems

### 参考プロジェクト
- ArduPilot
- PX4 Autopilot
- Betaflight
- Cleanflight

### 学術的背景
- Modern Control Engineering (Ogata)
- Probabilistic Robotics (Thrun, Burgard, Fox)
- Handbook of Unmanned Aerial Vehicles

### 教育資料・参考文献
#### StampFly関連資料
- [StampFlyで学ぶマルチコプタ制御](https://www.docswell.com/s/Kouhei_Ito/K38V1P-2024-02-10-094123) - 314.3K views
  - M5StampFlyを用いたマルチコプタ制御の実践的解説
  - 制御理論から実装まで包括的に解説
- [2025StampFly勉強会](https://www.docswell.com/s/Kouhei_Ito/K4VR7G-2025-03-23-104258) - 57.3K views
  - 最新の技術動向と実装手法
  - 教育現場での活用方法
- [StampFly_Seminar資料](https://www.docswell.com/s/Kouhei_Ito/K228YN-2024-10-27-074715) - 16.1K views
  - セミナー形式での詳細技術解説
  - 実機デモンストレーション

#### 基礎理論・制御工学
- [マルチコプタの運動と制御](https://www.docswell.com/s/Kouhei_Ito/K2N1XV-2023-08-27-113932) - 102.2K views
  - 航空工学の基礎から制御理論まで包括的解説
  - 運動方程式、PID制御、姿勢表現の理論的基盤
  - ドローン制御の数学的基礎を体系的に学習可能
- [カルマンフィルタ](https://www.docswell.com/s/Kouhei_Ito/KXGNQG-2023-08-27-110758) - 45.6K views
  - 状態推定理論の基礎
  - センサフュージョンへの応用
- [PID制御入門](https://www.docswell.com/s/Kouhei_Ito/K1N9YG-2023-08-27-110432) - 35.2K views
  - 制御工学の基礎
  - パラメータ調整手法
- [最適レギュレータ](https://www.docswell.com/s/Kouhei_Ito/K94N1G-2023-08-27-110613) - 28.1K views
  - 現代制御理論の応用
  - LQR制御の実装

#### シミュレーション・体験学習
- [2Dシミュレーション](https://www.docswell.com/s/Kouhei_Ito/K7G9YN-2023-08-27-111029) - 22.8K views
  - 制御システムの動作確認
  - パラメータ調整の事前検証
- [プログラム可能なドローンを体験！](https://www.docswell.com/s/Kouhei_Ito/K7RYG1-2024-07-15-124836) - 10.8K views
  - 体験型学習教材
  - プログラミング入門

## 免責事項

### 使用に関する免責
1. **教育目的限定**: 本プロジェクトの内容は教育・学習目的に限定されています。
2. **安全責任**: 実機での実装・テストは使用者の責任で行い、適切な安全対策を講じてください。
3. **損害免責**: 本プロジェクトの使用により生じた直接的・間接的損害について、作成者は一切責任を負いません。
4. **法規制遵守**: 各国・地域の法規制を遵守し、許可された環境でのみ使用してください。
5. **技術的制限**: 提供される情報は現状有姿での提供であり、動作保証はいたしません。

### 飛行安全に関する注意事項
- **屋内飛行推奨**: 初期テストは屋内の安全な環境で実施してください
- **プロペラ脱落リスク**: 個体差によりプロペラが緩い場合があり、回転中に上方向に脱落する可能性があります
- **視線注意**: 回転中のプロペラを上から覗かないでください
- **事前点検**: プロペラの差し込み具合を確認し、緩い場合は交換を検討してください
- **飛行制限**: 人や物から十分な距離を保って飛行してください
- **バッテリー管理**: リチウムポリマーバッテリーの取り扱いには十分注意してください
- **緊急時対応**: 緊急時の対応手順を事前に確認してください

### 技術的免責
- **互換性**: ハードウェア・ソフトウェアの互換性は保証されません
- **性能**: 記載された性能値は理論値であり、実際の性能を保証するものではありません
- **更新**: 技術の進歩により内容が陳腐化する可能性があります

## 著作権・ライセンス

### 著作権表示
```
Copyright (c) 2025 Kouhei Ito
All rights reserved.
```

### ライセンス条項
本プロジェクトは以下のライセンスの下で提供されます：

#### ドキュメント・解説資料
- **ライセンス**: Creative Commons Attribution 4.0 International (CC BY 4.0)
- **許可事項**: 複製、頒布、展示、実演、派生作品の作成、商用利用
- **条件**: 適切なクレジット表示、ライセンスへのリンク、変更の明示

#### ソースコード
- **ライセンス**: MIT License
- **許可事項**: 商用利用、修正、頒布、私的利用、特許利用
- **条件**: ライセンスと著作権表示の保持
- **免責**: 無保証での提供

### 第三者ライセンス
本プロジェクトで使用する第三者ライブラリ・コンポーネント：

#### ESP-IDF
- **ライセンス**: Apache License 2.0
- **著作権者**: Espressif Systems

#### FreeRTOS
- **ライセンス**: MIT License
- **著作権者**: Amazon.com, Inc.

#### センサライブラリ
- **BMI270**: Bosch Sensortec GmbH
- **BMM150**: Bosch Sensortec GmbH
- **BMP280**: Bosch Sensortec GmbH
- **VL53L3CX**: STMicroelectronics
- **PMW3901MB**: PixArt Imaging Inc.

### 商標について
- **M5Stack**: M5Stack Technology Co., Ltd.の商標です
- **ESP32**: Espressif Systems (Shanghai) Co., Ltd.の商標です
- **その他**: 記載されている会社名、製品名は各社の商標または登録商標です

### 引用・参考文献の取り扱い
学術的・技術的文献からの引用は適切な形式で明記し、著作権法の範囲内で使用しています。

### 貢献者への帰属
本プロジェクトへの貢献者は以下の通りです：
- プロジェクト発起人: Kouhei Ito
- 技術監修: Kouhei Ito
- コード貢献者: Kouhei Ito
- レビュアー: Kouhei Ito

### ライセンス変更
将来的なライセンス変更は貢献者の合意の下で行われます。

---

## 連絡先・サポート

### 技術的質問
- **GitHub Issues**: [https://github.com/kouhei1970/stampfly-control-guide]/issues
- **技術フォーラム**: [https://github.com/kouhei1970/stampfly-control-guide]

### ライセンス・法的問題
- **メール**: kouhei.ito@itolab-ktc.com

### 貢献方法
- **Pull Request**: GitHub経由での貢献を歓迎します
- **Issue報告**: バグ報告や改善提案をお待ちしています

---

**文書管理**
- 作成者: Kouhei Ito
- 最終更新: 2025-07-02
- バージョン: 1.0
- 承認者: Kouhei Ito

**免責・著作権条項追加日**: 2025-07-02